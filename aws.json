{
    "builders":[
        {
            "name" : "aws-basewindows",
            "type": "amazon-ebs",
            "access_key": "{{user `aws_accesskey`}}",
            "secret_key": "{{user `aws_secretkey`}}",
            "user_data_file": "./scripts/aws/bootstrap-aws.txt",
            "region": "eu-west-1",
            "source_ami": "ami-8519a9f6",
            "force_deregister" : "true",
            "instance_type": "t2.medium",
            "ami_name": "{{user `ami_name`}}",
            "ami_description" : "Windows 2012 r2 web role created by packer",
            "communicator":"winrm",
            "winrm_username":"Administrator",
            "winrm_port":"5985",
            "winrm_timeout":"120m",
            "launch_block_device_mappings" :
            [
            	{
            		"device_name" : "/dev/sda1",
            		"volume_size" : 80
            	},
            	{
            		"device_name" : "/dev/sda2",
            		"volume_size" : 40
            	}
            ]
        }
    ],
    "provisioners":[
        {
            "type":"powershell",
            "only": ["aws-basewindows"],
            "scripts":[
                "./scripts/shared/install-chocolatey.ps1",
                "./scripts/shared/install-winfeatures.ps1"
            ]
        },
        {
            "type": "powershell",
            "only": ["aws-basewindows"],
            "inline": [
                "# Enable the system password to be retrieved from the AWS Console after this AMI is built and used to launch code",
                "$ec2config = [xml] (get-content 'C:\\Program Files\\Amazon\\Ec2ConfigService\\Settings\\config.xml')",
                "($ec2config.ec2configurationsettings.plugins.plugin | where {$_.name -eq \"Ec2SetPassword\"}).state = \"Enabled\"",
                "$ec2config.save(\"C:\\Program Files\\Amazon\\Ec2ConfigService\\Settings\\config.xml\")"
            ]
        }
    ],
	"variables": {
        "ami_name" : "",
        "aws_accesskey" : "",
        "aws_secretkey" : ""
	}
}

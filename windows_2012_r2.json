{
    "builders":[
        {
            "name":"vmware-basewindows",
            "type":"vmware-iso",
            "iso_url":"./iso/en_windows_server_2012_r2_with_update_x64_dvd_6052708.iso",
            "iso_checksum_type":"md5",
            "iso_checksum":"78bff6565f178ed08ab534397fe44845",
            "headless":false,
            "boot_wait":"2m",
            "shutdown_command":"shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\"",
            "guest_os_type":"windows8srv-64",
            "disk_size":122880,
            "vnc_port_min":5900,
            "vnc_port_max":5980,
            "communicator":"winrm",
            "winrm_username":"miranda",
            "winrm_password":"miranda",
            "winrm_port":"5985",
            "winrm_timeout":"120m",
            "floppy_files":[
                "./answer_files/Autounattend.xml",
                "./scripts/shared/windows-updates.ps1"
            ],
            "vmx_data":{
                "RemoteDisplay.vnc.enabled":"false",
                "RemoteDisplay.vnc.port":"5900",
                "memsize":"8192",
                "numvcpus":"2",
                "scsi0.virtualDev":"lsisas1068"
            }
        },
        {
            "name":"vmware-webserver",
            "type":"vmware-vmx",
            "source_path":"./output-vmware-basewindows/packer-vmware-basewindows.vmx",
            "headless":false,
            "boot_wait":"2m",
            "shutdown_command":"shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\"",
            "vnc_port_min":5900,
            "vnc_port_max":5980,
            "communicator":"winrm",
            "winrm_username":"miranda",
            "winrm_password":"miranda",
            "winrm_port":"5985",
            "winrm_timeout":"120m",
            "floppy_files":[
                "./scripts/vmware/sysprep-tools.ps1",
                "./answer_files/Autounattend-sysprep.xml"
            ],
            "vmx_data":{
                "RemoteDisplay.vnc.enabled":"false",
                "RemoteDisplay.vnc.port":"5900",
                "memsize":"8192",
                "numvcpus":"2",
                "scsi0.virtualDev":"lsisas1068"
            }
        },
        {
            "name":"virtualbox-stage1-base",
            "type":"virtualbox-iso",
            "iso_url":"./iso/en_windows_server_2012_r2_with_update_x64_dvd_6052708.iso",
            "iso_checksum_type":"md5",
            "iso_checksum":"78bff6565f178ed08ab534397fe44845",
            "headless":false,
            "boot_wait":"2m",
            "shutdown_command":"shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\"",
            "guest_additions_mode" : "disable",
            "guest_os_type":"Windows2012_64",
            "disk_size":122880,
            "communicator":"winrm",
            "winrm_username":"miranda",
            "winrm_password":"miranda",
            "winrm_port":"5985",
            "winrm_timeout":"120m",
            "floppy_files":[
                "./answer_files/Autounattend.xml",
                "./scripts/shared/windows-updates.ps1"
            ],
            "vboxmanage":[
                [
                    "modifyvm",
                    "{{.Name}}",
                    "--memory",
                    "5048"
                ],
                [
                    "modifyvm",
                    "{{.Name}}",
                    "--cpus",
                    "2"
                ]
            ]
        },
        {
            "name":"virtualbox-stage2-devdesktop",
            "type":"virtualbox-ovf",
            "source_path":"./output-virtualbox-stage1-base/{{user `ovfsource`}}",
            "headless":false,
            "boot_wait":"2m",
            "shutdown_command":"shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\"",
            "guest_additions_mode" : "disable",
            "communicator":"winrm",
            "winrm_username":"miranda",
            "winrm_password":"miranda",
            "winrm_port":"5985",
            "winrm_timeout":"120m",
            "vboxmanage":[
                [
                    "modifyvm",
                    "{{.Name}}",
                    "--memory",
                    "5048"
                ],
                [
                    "modifyvm",
                    "{{.Name}}",
                    "--cpus",
                    "2"
                ]
            ]
        },
        {
            "name" : "aws-basewindows",
            "type": "amazon-ebs",
            "access_key": "{{user `aws_accesskey`}}",
            "secret_key": "{{user `aws_secretkey`}}",
            "user_data_file": "./scripts/aws/bootstrap-aws.txt",
            "region": "eu-west-1",
            "source_ami": "ami-8519a9f6",
            "instance_type": "t2.medium",
            "ami_name": "{{user `ami_name`}}",
            "communicator":"winrm",
            "winrm_username":"Administrator",
            "winrm_port":"5985",
            "winrm_timeout":"120m"
        }
    ],
    "provisioners":[
        {
            "type":"powershell",
            "only": ["vmware-webserver"],
            "scripts":[
                "./scripts/vmware/install-vmwaretools.ps1",
                "./scripts/vmware/copy-sysprep-answerfile.ps1"
            ]
        },
        {
            "type":"powershell",
            "only": ["vmware-webserver", "aws-basewindows"],
            "scripts":[
                "./scripts/shared/install-chocolatey.ps1",
                "./scripts/shared/install-winfeatures.ps1"
            ]
        },
        {
            "type":"powershell",
            "only": ["virtualbox-stage2-devdesktop"],
            "scripts":[
                "./scripts/shared/install-chocolatey.ps1",
                "./scripts/shared/install-winfeatures.ps1",
                "./scripts/virtualbox/install-dev-software.ps1"
            ]
        },
        {
            "type": "powershell",
            "only": ["aws-basewindows"],
            "inline": [
                "# Enable the system password to be retrieved from the AWS Console after this AMI is built and used to launch code",
                "$ec2config = [xml] (get-content 'C:\\Program Files\\Amazon\\Ec2ConfigService\\Settings\\config.xml')",
                "($ec2config.ec2configurationsettings.plugins.plugin | where {$_.name -eq \"Ec2SetPassword\"}).state = \"Enabled\"",
                "$ec2config.save(\"C:\\Program Files\\Amazon\\Ec2ConfigService\\Settings\\config.xml\")"
            ]
        }
    ],
	"variables": {
	    "ovfsource": "output-virtualbox-stage1-base/output-virtualbox-stage1-base.ovf",
        "ami_name" : "",
        "aws_accesskey" : "",
        "aws_secretkey" : ""
	}
}
